"use strict";var e=require("lodash"),t=require("@usebruno/lang"),r=require("node:worker_threads"),s=require("node:path");function o(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var a=o(e);const n=[{type:"authorization",sendIn:"headers",source:"oauth2_additional_parameters_auth_req_headers"},{type:"authorization",sendIn:"queryparams",source:"oauth2_additional_parameters_auth_req_queryparams"},{type:"token",sendIn:"headers",source:"oauth2_additional_parameters_access_token_req_headers"},{type:"token",sendIn:"queryparams",source:"oauth2_additional_parameters_access_token_req_queryparams"},{type:"token",sendIn:"body",source:"oauth2_additional_parameters_access_token_req_bodyvalues"},{type:"refresh",sendIn:"headers",source:"oauth2_additional_parameters_refresh_token_req_headers"},{type:"refresh",sendIn:"queryparams",source:"oauth2_additional_parameters_refresh_token_req_queryparams"},{type:"refresh",sendIn:"body",source:"oauth2_additional_parameters_refresh_token_req_bodyvalues"}],u=(e,t)=>e?.length?e.map((e=>({...e,sendIn:t}))):[],i=(e,t,r)=>{if(!((e,t)=>"authorization"===e?"authorization_code"===t||"implicit"===t:"token"!==e&&"refresh"!==e||"implicit"!==t)(t,r))return[];const s=n.filter((e=>e.type===t)),o=[];for(const t of s){const r=e[t.source],s=u(r,t.sendIn);o.push(...s)}return o},c=e=>{const t=e.auth.oauth2.grantType,r={};try{const s=["authorization","token","refresh"];for(const o of s){const s=i(e,o,t);s.length>0&&(r[o]=s)}}catch(e){console.error(e),console.error("Error while getting the oauth2 additional parameters!")}return r},p=(e,r=!1)=>{try{const s=r?e:t.collectionBruToJson(e),o={request:{headers:a.get(s,"headers",[]),auth:a.get(s,"auth",{}),script:a.get(s,"script",{}),vars:a.get(s,"vars",{}),tests:a.get(s,"tests","")},settings:a.get(s,"settings",{}),docs:a.get(s,"docs","")};if(s.meta&&(o.meta={name:s.meta.name},void 0!==s.meta.seq)){const e=s.meta.seq;o.meta.seq=isNaN(e)?1:Number(e)}const n=s?.auth?.oauth2?.grantType;if(n){const e=c(s);Object.keys(e).length>0&&(o.request.auth.oauth2.additionalParameters=e)}return o}catch(e){return Promise.reject(e)}},h=(e,r)=>{try{const s={headers:a.get(e,"request.headers",[]),script:{req:a.get(e,"request.script.req",""),res:a.get(e,"request.script.res","")},vars:{req:a.get(e,"request.vars.req",[]),res:a.get(e,"request.vars.res",[])},tests:a.get(e,"request.tests",""),auth:a.get(e,"request.auth",{}),docs:a.get(e,"docs","")};if(e?.meta&&(s.meta={name:e.meta.name},void 0!==e.meta.seq)){const t=e.meta.seq;s.meta.seq=isNaN(t)?1:Number(t)}return r||(s.auth=a.get(e,"request.auth",{})),t.jsonToCollectionBru(s)}catch(e){throw e}};class d{constructor(){this.queue=[],this.isProcessing=!1,this.workers={}}async getWorkerForScriptPath(e){this.workers||(this.workers={});let t=this.workers[e];return t&&-1!==t.threadId||(this.workers[e]=t=new r.Worker(e)),t}async enqueue(e){const{priority:t,scriptPath:r,data:s,taskType:o}=e;return new Promise(((e,a)=>{this.queue.push({priority:t,scriptPath:r,data:s,taskType:o,resolve:e,reject:a}),this.queue?.sort(((e,t)=>e?.priority-t?.priority)),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{scriptPath:e,data:t,taskType:r,resolve:s,reject:o}=this.queue.shift();try{const o=await this.runWorker({scriptPath:e,data:t,taskType:r});s?.(o)}catch(e){o?.(e)}finally{this.isProcessing=!1,this.processQueue()}}async runWorker({scriptPath:e,data:t,taskType:r}){return new Promise((async(s,o)=>{let a=await this.getWorkerForScriptPath(e);const n=e=>{a.off("message",n),a.off("error",u),a.off("exit",i),e?.error?o(new Error(e?.error)):s(e)},u=e=>{a.off("message",n),a.off("error",u),a.off("exit",i),o(e)},i=t=>{a.off("message",n),a.off("error",u),a.off("exit",i),delete this.workers[e],o(new Error(`Worker stopped with exit code ${t}`))};a.on("message",n),a.on("error",u),a.on("exit",i),a.postMessage({taskType:r,data:t})}))}async cleanup(){const e=Object.values(this.workers).map((e=>-1!==e.threadId?e.terminate():Promise.resolve()));await Promise.allSettled(e),this.workers={}}}const g=[{maxSize:.005},{maxSize:.1},{maxSize:1},{maxSize:10},{maxSize:100}];class m{constructor(){this.workerQueues=g?.map((e=>({maxSize:e?.maxSize,workerQueue:new d})))}getWorkerQueue(e){const t=this.workerQueues.find((t=>t.maxSize>=e));return t?.workerQueue??this.workerQueues[this.workerQueues.length-1].workerQueue}async enqueueTask({data:e,taskType:t}){const r=(e=>("string"==typeof e?Buffer.byteLength(e,"utf8"):Buffer.byteLength(JSON.stringify(e),"utf8"))/1048576)(e),o=this.getWorkerQueue(r),a=s.join(__dirname,"./workers/worker-script.js");return o.enqueue({data:e,priority:r,scriptPath:a,taskType:t})}async parseRequest(e){return this.enqueueTask({data:e,taskType:"parse"})}async stringifyRequest(e){return this.enqueueTask({data:e,taskType:"stringify"})}async cleanup(){const e=this.workerQueues.map((({workerQueue:e})=>e.cleanup()));await Promise.allSettled(e)}}let f=null;const y=()=>(f||(f=new m),f);exports.BruParserWorker=m,exports.parseCollection=(e,t={format:"bru"})=>{if("bru"===t.format)return p(e);throw new Error(`Unsupported format: ${t.format}`)},exports.parseDotEnv=e=>t.dotenvToJson(e),exports.parseEnvironment=(e,r={format:"bru"})=>{if("bru"===r.format)return(e=>{try{const r=t.bruToEnvJsonV2(e);return r&&r.variables&&r.variables.length&&a.each(r.variables,(e=>e.type="text")),r}catch(e){return Promise.reject(e)}})(e);throw new Error(`Unsupported format: ${r.format}`)},exports.parseFolder=(e,t={format:"bru"})=>{if("bru"===t.format)return p(e);throw new Error(`Unsupported format: ${t.format}`)},exports.parseRequest=(e,r={format:"bru"})=>{if("bru"===r.format)return((e,r=!1)=>{try{const s=r?e:t.bruToJsonV2(e);let o=a.get(s,"meta.type");switch(o){case"http":default:o="http-request";break;case"graphql":o="graphql-request";break;case"grpc":o="grpc-request"}const n=a.get(s,"meta.seq"),u={type:o,name:a.get(s,"meta.name"),seq:a.isNaN(n)?1:Number(n),settings:a.get(s,"settings",{}),tags:a.get(s,"meta.tags",[]),request:{method:"grpc-request"===o?a.get(s,"grpc.method",""):String(a.get(s,"http.method")??"").toUpperCase(),url:a.get(s,"grpc-request"===o?"grpc.url":"http.url"),headers:"grpc-request"===o?a.get(s,"metadata",[]):a.get(s,"headers",[]),auth:a.get(s,"auth",{}),body:a.get(s,"body",{}),script:a.get(s,"script",{}),vars:a.get(s,"vars",{}),assertions:a.get(s,"assertions",[]),tests:a.get(s,"tests",""),docs:a.get(s,"docs","")}};if("grpc-request"===o){const e=a.get(s,"grpc.methodType");e&&(u.request.methodType=e);const t=a.get(s,"grpc.protoPath");t&&(u.request.protoPath=t),u.request.auth.mode=a.get(s,"grpc.auth","none"),u.request.body=a.get(s,"body",{mode:"grpc",grpc:a.get(s,"body.grpc",[{name:"message 1",content:"{}"}])})}else u.request.params=a.get(s,"params",[]),u.request.auth.mode=a.get(s,"http.auth","none"),u.request.body.mode=a.get(s,"http.body","none");const i=s?.auth?.oauth2?.grantType;if(i){const e=c(s);Object.keys(e||{}).length>0&&(u.request.auth.oauth2.additionalParameters=e)}return u}catch(e){throw e}})(e);throw new Error(`Unsupported format: ${r.format}`)},exports.parseRequestAndRedactBody=(e,t={format:"bru"})=>{if("bru"===t.format)return(e=>{try{const t=["body:json {","body:text {","body:xml {","body:sparql {","body:graphql {"];e=(e||"").replace(/\r\n/g,"\n");const r="\n",s=e=>e&&e.length?e.split(r).map((e=>e.replace(/^  /,""))).join(r):e||"";let o=e.split(`${r}}${r}`);o=o.filter(Boolean).map((e=>e.trim()));const a=o.filter((e=>t.some((t=>e.startsWith(t))))).reduce(((e,t)=>{const o=t.split(r)[0].split("body:")[1].split(/\s/)[0],a=t.split(r).slice(1).join(r),n=s(a);return e[o]=n,e}),{});return{bruFileStringWithRedactedBody:o.filter((e=>!t.some((t=>e.startsWith(t))))).join(`${r}}${r}${r}`).concat(`${r}}${r}`),extractedBodyContent:a}}catch(t){return console.error("Error parsing and redacting body data:",t),{bruFileStringWithRedactedBody:e,extractedBodyContent:{}}}})(e);throw new Error(`Unsupported format: ${t.format}`)},exports.parseRequestViaWorker=async e=>{const t=y();return await t.parseRequest(e)},exports.stringifyCollection=(e,t={format:"bru"})=>{if("bru"===t.format)return h(e,!1);throw new Error(`Unsupported format: ${t.format}`)},exports.stringifyEnvironment=(e,r={format:"bru"})=>{if("bru"===r.format)return(e=>{try{return t.envJsonToBruV2(e)}catch(e){throw e}})(e);throw new Error(`Unsupported format: ${r.format}`)},exports.stringifyFolder=(e,t={format:"bru"})=>{if("bru"===t.format)return h(e,!0);throw new Error(`Unsupported format: ${t.format}`)},exports.stringifyRequest=(e,r={format:"bru"})=>{if("bru"===r.format)return(e=>{try{let r=a.get(e,"type");switch(r){case"http-request":default:r="http";break;case"graphql-request":r="graphql";break;case"grpc-request":r="grpc"}const s=a.get(e,"seq"),o={meta:{name:a.get(e,"name"),type:r,seq:a.isNaN(s)?1:Number(s),tags:a.get(e,"tags",[])}};if("http"===r||"graphql"===r)o.http={method:String(a.get(e,"request.method")??"").toLowerCase(),url:a.get(e,"request.url"),auth:a.get(e,"request.auth.mode","none"),body:a.get(e,"request.body.mode","none")},o.params=a.get(e,"request.params",[]),o.body=a.get(e,"request.body",{mode:"json",json:"{}"});else if("grpc"===r){o.grpc={url:a.get(e,"request.url"),auth:a.get(e,"request.auth.mode","none"),body:a.get(e,"request.body.mode","grpc")};const t=a.get(e,"request.method"),r=a.get(e,"request.methodType"),s=a.get(e,"request.protoPath");t&&(o.grpc.method=t),r&&(o.grpc.methodType=r),s&&(o.grpc.protoPath=s),o.body=a.get(e,"request.body",{mode:"grpc",grpc:a.get(e,"request.body.grpc",[{name:"message 1",content:"{}"}])})}return"grpc"===r?o.metadata=a.get(e,"request.headers",[]):o.headers=a.get(e,"request.headers",[]),o.auth=a.get(e,"request.auth",{}),o.script=a.get(e,"request.script",{}),o.vars={req:a.get(e,"request.vars.req",[]),res:a.get(e,"request.vars.res",[])},o.assertions=a.get(e,"request.assertions",[]),o.tests=a.get(e,"request.tests",""),o.settings=a.get(e,"settings",{}),o.docs=a.get(e,"request.docs",""),t.jsonToBruV2(o)}catch(e){throw e}})(e);throw new Error(`Unsupported format: ${r.format}`)},exports.stringifyRequestViaWorker=async e=>{const t=y();return await t.stringifyRequest(e)};
//# sourceMappingURL=index.js.map
