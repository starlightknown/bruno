import*as e from"lodash";import{bruToJsonV2 as t,jsonToBruV2 as r,collectionBruToJson as s,jsonToCollectionBru as a,bruToEnvJsonV2 as o,envJsonToBruV2 as n,dotenvToJson as u}from"@usebruno/lang";import{Worker as i}from"node:worker_threads";import c from"node:path";const h=[{type:"authorization",sendIn:"headers",source:"oauth2_additional_parameters_auth_req_headers"},{type:"authorization",sendIn:"queryparams",source:"oauth2_additional_parameters_auth_req_queryparams"},{type:"token",sendIn:"headers",source:"oauth2_additional_parameters_access_token_req_headers"},{type:"token",sendIn:"queryparams",source:"oauth2_additional_parameters_access_token_req_queryparams"},{type:"token",sendIn:"body",source:"oauth2_additional_parameters_access_token_req_bodyvalues"},{type:"refresh",sendIn:"headers",source:"oauth2_additional_parameters_refresh_token_req_headers"},{type:"refresh",sendIn:"queryparams",source:"oauth2_additional_parameters_refresh_token_req_queryparams"},{type:"refresh",sendIn:"body",source:"oauth2_additional_parameters_refresh_token_req_bodyvalues"}],p=(e,t)=>e?.length?e.map((e=>({...e,sendIn:t}))):[],d=(e,t,r)=>{if(!((e,t)=>"authorization"===e?"authorization_code"===t||"implicit"===t:"token"!==e&&"refresh"!==e||"implicit"!==t)(t,r))return[];const s=h.filter((e=>e.type===t)),a=[];for(const t of s){const r=e[t.source],s=p(r,t.sendIn);a.push(...s)}return a},g=e=>{const t=e.auth.oauth2.grantType,r={};try{const s=["authorization","token","refresh"];for(const a of s){const s=d(e,a,t);s.length>0&&(r[a]=s)}}catch(e){console.error(e),console.error("Error while getting the oauth2 additional parameters!")}return r},m=(t,r=!1)=>{try{const a=r?t:s(t),o={request:{headers:e.get(a,"headers",[]),auth:e.get(a,"auth",{}),script:e.get(a,"script",{}),vars:e.get(a,"vars",{}),tests:e.get(a,"tests","")},settings:e.get(a,"settings",{}),docs:e.get(a,"docs","")};if(a.meta&&(o.meta={name:a.meta.name},void 0!==a.meta.seq)){const e=a.meta.seq;o.meta.seq=isNaN(e)?1:Number(e)}const n=a?.auth?.oauth2?.grantType;if(n){const e=g(a);Object.keys(e).length>0&&(o.request.auth.oauth2.additionalParameters=e)}return o}catch(e){return Promise.reject(e)}},f=(t,r)=>{try{const s={headers:e.get(t,"request.headers",[]),script:{req:e.get(t,"request.script.req",""),res:e.get(t,"request.script.res","")},vars:{req:e.get(t,"request.vars.req",[]),res:e.get(t,"request.vars.res",[])},tests:e.get(t,"request.tests",""),auth:e.get(t,"request.auth",{}),docs:e.get(t,"docs","")};if(t?.meta&&(s.meta={name:t.meta.name},void 0!==t.meta.seq)){const e=t.meta.seq;s.meta.seq=isNaN(e)?1:Number(e)}return r||(s.auth=e.get(t,"request.auth",{})),a(s)}catch(e){throw e}};class y{constructor(){this.queue=[],this.isProcessing=!1,this.workers={}}async getWorkerForScriptPath(e){this.workers||(this.workers={});let t=this.workers[e];return t&&-1!==t.threadId||(this.workers[e]=t=new i(e)),t}async enqueue(e){const{priority:t,scriptPath:r,data:s,taskType:a}=e;return new Promise(((e,o)=>{this.queue.push({priority:t,scriptPath:r,data:s,taskType:a,resolve:e,reject:o}),this.queue?.sort(((e,t)=>e?.priority-t?.priority)),this.processQueue()}))}async processQueue(){if(this.isProcessing||0===this.queue.length)return;this.isProcessing=!0;const{scriptPath:e,data:t,taskType:r,resolve:s,reject:a}=this.queue.shift();try{const a=await this.runWorker({scriptPath:e,data:t,taskType:r});s?.(a)}catch(e){a?.(e)}finally{this.isProcessing=!1,this.processQueue()}}async runWorker({scriptPath:e,data:t,taskType:r}){return new Promise((async(s,a)=>{let o=await this.getWorkerForScriptPath(e);const n=e=>{o.off("message",n),o.off("error",u),o.off("exit",i),e?.error?a(new Error(e?.error)):s(e)},u=e=>{o.off("message",n),o.off("error",u),o.off("exit",i),a(e)},i=t=>{o.off("message",n),o.off("error",u),o.off("exit",i),delete this.workers[e],a(new Error(`Worker stopped with exit code ${t}`))};o.on("message",n),o.on("error",u),o.on("exit",i),o.postMessage({taskType:r,data:t})}))}async cleanup(){const e=Object.values(this.workers).map((e=>-1!==e.threadId?e.terminate():Promise.resolve()));await Promise.allSettled(e),this.workers={}}}const q=[{maxSize:.005},{maxSize:.1},{maxSize:1},{maxSize:10},{maxSize:100}];class l{constructor(){this.workerQueues=q?.map((e=>({maxSize:e?.maxSize,workerQueue:new y})))}getWorkerQueue(e){const t=this.workerQueues.find((t=>t.maxSize>=e));return t?.workerQueue??this.workerQueues[this.workerQueues.length-1].workerQueue}async enqueueTask({data:e,taskType:t}){const r=(e=>("string"==typeof e?Buffer.byteLength(e,"utf8"):Buffer.byteLength(JSON.stringify(e),"utf8"))/1048576)(e),s=this.getWorkerQueue(r),a=c.join(__dirname,"./workers/worker-script.js");return s.enqueue({data:e,priority:r,scriptPath:a,taskType:t})}async parseRequest(e){return this.enqueueTask({data:e,taskType:"parse"})}async stringifyRequest(e){return this.enqueueTask({data:e,taskType:"stringify"})}async cleanup(){const e=this.workerQueues.map((({workerQueue:e})=>e.cleanup()));await Promise.allSettled(e)}}const b=(r,s={format:"bru"})=>{if("bru"===s.format)return((r,s=!1)=>{try{const a=s?r:t(r);let o=e.get(a,"meta.type");switch(o){case"http":default:o="http-request";break;case"graphql":o="graphql-request";break;case"grpc":o="grpc-request"}const n=e.get(a,"meta.seq"),u={type:o,name:e.get(a,"meta.name"),seq:e.isNaN(n)?1:Number(n),settings:e.get(a,"settings",{}),tags:e.get(a,"meta.tags",[]),request:{method:"grpc-request"===o?e.get(a,"grpc.method",""):String(e.get(a,"http.method")??"").toUpperCase(),url:e.get(a,"grpc-request"===o?"grpc.url":"http.url"),headers:"grpc-request"===o?e.get(a,"metadata",[]):e.get(a,"headers",[]),auth:e.get(a,"auth",{}),body:e.get(a,"body",{}),script:e.get(a,"script",{}),vars:e.get(a,"vars",{}),assertions:e.get(a,"assertions",[]),tests:e.get(a,"tests",""),docs:e.get(a,"docs","")}};if("grpc-request"===o){const t=e.get(a,"grpc.methodType");t&&(u.request.methodType=t);const r=e.get(a,"grpc.protoPath");r&&(u.request.protoPath=r),u.request.auth.mode=e.get(a,"grpc.auth","none"),u.request.body=e.get(a,"body",{mode:"grpc",grpc:e.get(a,"body.grpc",[{name:"message 1",content:"{}"}])})}else u.request.params=e.get(a,"params",[]),u.request.auth.mode=e.get(a,"http.auth","none"),u.request.body.mode=e.get(a,"http.body","none");const i=a?.auth?.oauth2?.grantType;if(i){const e=g(a);Object.keys(e||{}).length>0&&(u.request.auth.oauth2.additionalParameters=e)}return u}catch(e){throw e}})(r);throw new Error(`Unsupported format: ${s.format}`)},w=(e,t={format:"bru"})=>{if("bru"===t.format)return(e=>{try{const t=["body:json {","body:text {","body:xml {","body:sparql {","body:graphql {"];e=(e||"").replace(/\r\n/g,"\n");const r="\n",s=e=>e&&e.length?e.split(r).map((e=>e.replace(/^  /,""))).join(r):e||"";let a=e.split(`${r}}${r}`);a=a.filter(Boolean).map((e=>e.trim()));const o=a.filter((e=>t.some((t=>e.startsWith(t))))).reduce(((e,t)=>{const a=t.split(r)[0].split("body:")[1].split(/\s/)[0],o=t.split(r).slice(1).join(r),n=s(o);return e[a]=n,e}),{});return{bruFileStringWithRedactedBody:a.filter((e=>!t.some((t=>e.startsWith(t))))).join(`${r}}${r}${r}`).concat(`${r}}${r}`),extractedBodyContent:o}}catch(t){return console.error("Error parsing and redacting body data:",t),{bruFileStringWithRedactedBody:e,extractedBodyContent:{}}}})(e);throw new Error(`Unsupported format: ${t.format}`)},k=(t,s={format:"bru"})=>{if("bru"===s.format)return(t=>{try{let s=e.get(t,"type");switch(s){case"http-request":default:s="http";break;case"graphql-request":s="graphql";break;case"grpc-request":s="grpc"}const a=e.get(t,"seq"),o={meta:{name:e.get(t,"name"),type:s,seq:e.isNaN(a)?1:Number(a),tags:e.get(t,"tags",[])}};if("http"===s||"graphql"===s)o.http={method:String(e.get(t,"request.method")??"").toLowerCase(),url:e.get(t,"request.url"),auth:e.get(t,"request.auth.mode","none"),body:e.get(t,"request.body.mode","none")},o.params=e.get(t,"request.params",[]),o.body=e.get(t,"request.body",{mode:"json",json:"{}"});else if("grpc"===s){o.grpc={url:e.get(t,"request.url"),auth:e.get(t,"request.auth.mode","none"),body:e.get(t,"request.body.mode","grpc")};const r=e.get(t,"request.method"),s=e.get(t,"request.methodType"),a=e.get(t,"request.protoPath");r&&(o.grpc.method=r),s&&(o.grpc.methodType=s),a&&(o.grpc.protoPath=a),o.body=e.get(t,"request.body",{mode:"grpc",grpc:e.get(t,"request.body.grpc",[{name:"message 1",content:"{}"}])})}return"grpc"===s?o.metadata=e.get(t,"request.headers",[]):o.headers=e.get(t,"request.headers",[]),o.auth=e.get(t,"request.auth",{}),o.script=e.get(t,"request.script",{}),o.vars={req:e.get(t,"request.vars.req",[]),res:e.get(t,"request.vars.res",[])},o.assertions=e.get(t,"request.assertions",[]),o.tests=e.get(t,"request.tests",""),o.settings=e.get(t,"settings",{}),o.docs=e.get(t,"request.docs",""),r(o)}catch(e){throw e}})(t);throw new Error(`Unsupported format: ${s.format}`)};let _=null;const P=()=>(_||(_=new l),_),v=async e=>{const t=P();return await t.parseRequest(e)},T=async e=>{const t=P();return await t.stringifyRequest(e)},x=(e,t={format:"bru"})=>{if("bru"===t.format)return m(e);throw new Error(`Unsupported format: ${t.format}`)},S=(e,t={format:"bru"})=>{if("bru"===t.format)return f(e,!1);throw new Error(`Unsupported format: ${t.format}`)},$=(e,t={format:"bru"})=>{if("bru"===t.format)return m(e);throw new Error(`Unsupported format: ${t.format}`)},j=(e,t={format:"bru"})=>{if("bru"===t.format)return f(e,!0);throw new Error(`Unsupported format: ${t.format}`)},Q=(t,r={format:"bru"})=>{if("bru"===r.format)return(t=>{try{const r=o(t);return r&&r.variables&&r.variables.length&&e.each(r.variables,(e=>e.type="text")),r}catch(e){return Promise.reject(e)}})(t);throw new Error(`Unsupported format: ${r.format}`)},z=(e,t={format:"bru"})=>{if("bru"===t.format)return(e=>{try{return n(e)}catch(e){throw e}})(e);throw new Error(`Unsupported format: ${t.format}`)},E=e=>u(e);export{l as BruParserWorker,x as parseCollection,E as parseDotEnv,Q as parseEnvironment,$ as parseFolder,b as parseRequest,w as parseRequestAndRedactBody,v as parseRequestViaWorker,S as stringifyCollection,z as stringifyEnvironment,j as stringifyFolder,k as stringifyRequest,T as stringifyRequestViaWorker};
//# sourceMappingURL=index.js.map
